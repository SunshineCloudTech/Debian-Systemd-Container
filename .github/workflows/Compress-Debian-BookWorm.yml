---
name: Compress Debian BookWorm Image

on:
  workflow_run:
    workflows: ["Build Debian BookWorm"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:

jobs:
  compress:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "Optimize Disk Space"
        uses: "hugoalh/disk-space-optimizer-ghaction@v0.8.0"
        with:
          operate_sudo: "True"
          general_include: ".+"
          docker_include: ".+"
          docker_prune: "True"
          docker_clean: "True"
          apt_prune: "True"
          apt_clean: "True"
          homebrew_prune: "True"
          homebrew_clean: "True"
          npm_prune: "True"
          npm_clean: "True"
          os_swap: "True"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker
        uses: docker/setup-docker-action@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull Base Image
        run: |
          docker pull sunshinecloud007/systemd-container:debian-bookworm-base
          docker images sunshinecloud007/systemd-container:debian-bookworm-base
          df -h

      - name: Compress Docker Image
        run: |
          export src_image_name=sunshinecloud007/systemd-container:debian-bookworm-base
          export docker_tmp_name=temp-bookworm
          echo "Creating temporary container from image..."
          docker create -it -P --name $docker_tmp_name $src_image_name
          echo "Exporting container to tar..."
          docker export $docker_tmp_name -o $docker_tmp_name.tar
          echo "Removing temporary container..."
          docker rm $docker_tmp_name
          echo "Removing base image..."
          docker rmi $src_image_name
          echo "Importing tar to image..."
          docker import $docker_tmp_name.tar sunshinecloud007/systemd-container:debian-bookworm-temp
          echo "Creating temporary container from imported image..."
          docker create -it -P --name $docker_tmp_name sunshinecloud007/systemd-container:debian-bookworm-temp bash
          echo "Committing container with metadata..."
          docker commit \
            --change='USER matrix0523' \
            --change='WORKDIR /home/matrix0523' \
            --change='ENTRYPOINT [ "/lib/systemd/systemd" ]' \
            $docker_tmp_name sunshinecloud007/systemd-container:debian-bookworm
          rm $docker_tmp_name.tar
          docker tag sunshinecloud007/systemd-container:debian-bookworm sunshinecloud007/systemd-container:debian-bookworm-latest
          docker images sunshinecloud007/systemd-container

      - name: Push Compressed Images
        run: |
          docker push sunshinecloud007/systemd-container:debian-bookworm
          docker push sunshinecloud007/systemd-container:debian-bookworm-latest

      - name: Print Disk Usage
        run: |
          df -h
